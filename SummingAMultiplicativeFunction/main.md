# Summing a multiplicative function

A <b>multiplicative function</b> $f(x)$ is a function over positive integers satisfying $f(1)=1$ and $f(a b)=f(a) f(b)$ for any two coprime positive integers $a$ and $b$.

For integer $k$ let $f_k(n)$ be a multiplicative function additionally satisfying $f_k(p^e)=p^k$ for any prime $p$ and any integer $e > 0$.<br /> 
For example, $f_1(2)=2$, $f_1(4)=2$, $f_1(18)=6$ and $f_2(18)=36$.

Let $\displaystyle S_k(n)=\sum_{i=1}^{n} f_k(i)$.
For example, $S_1(10)=41$, $S_1(100)=3512$, $S_2(100)=208090$, $S_1(10000)=35252550$ and $\displaystyle \sum_{k=1}^{3} S_k(10^{8}) \equiv 338787512 \pmod{ 1\,000\,000\,007}$.

Find $\displaystyle \sum_{k=1}^{50} S_k(10^{12}) \bmod 1\,000\,000\,007$.

## Solution

### Applying Griff's method

Fix $k$. Choose $g_{k}(n) = n^k$. Applying Griff's method we get:

$$
\begin{align*}
f_{k, p}(x)
&= \sum_{i \geq 0} f(p^i) x^i \\
&= 1 + \sum_{i \geq 1} p^k x^i \\
&= 1 - p^k + p^k \sum_{i \geq 0}  x^i \\
&= 1 - p^k + \frac{p^k}{1 - x} \\
\end{align*}
$$

$$
\begin{align*}
g_{k, p}(x)
&= \sum_{i \geq 0} g(p^i) x^i \\
&= \sum_{i \geq 0} p^{ki} x^i \\
&= \sum_{i \geq 0} (p^k x)^i \\
&= \frac{1}{1 - p^k x} \\
\end{align*}
$$

Therefore

$$
\begin{align*}
h_{k,p}(x)
&= f_{k, p}(x) / g_{k, p}(x) \\
&= (1 - p^k + \frac{p^k}{1 - x}) \cdot (1 - p^k x) \\
&= 1 - x^2 p^k (p^k - 1) - x^3 p^k (p^k - 1) - \dots \\
\end{align*}
$$

thus

$$
h_{k}(p) = 0 \\
h_{k}(p^i) = -p^k (p^k - 1) \\
$$

Therefore $h(n) \not= 0 \iff \text{n is powerful}$. Thus

### Calculating $S_k$

$$
\begin{align*}
S_k(N)
&= \sum_{n = 1}^N f_k(n) \\
&= \sum_{n = 1}^N \sum_{d \mid n} h_k(d) \cdot g_k(n / d) \\
&= \sum_{d = 1}^N \sum_{n = 1}^{N / d} h_k(d) \cdot g_k(n) \\
&= \sum_{\substack{d = 1 \\ \text{$d$ is powerful}}}^N h_k(d) \sum_{n = 1}^{N / d} g_k(n) \\
&= \sum_{\substack{d = 1 \\ \text{$d$ is powerful}}}^N h_k(d) \sum_{n = 1}^{N / d} n^k \\
&= \sum_{\substack{d = 1 \\ \text{$d$ is powerful}}}^N h_k(d) \cdot T_k(N / d) \\
\end{align*}
$$

where

$$
T_k(N) = \sum_{n = 1}^N g_k(n) = \sum_{n = 1}^N n^k
$$

### Calculating $T_k$

Fix a value of $k$. Let $T_{k}(N) = \sum_{j = 0}^{k + 1} c_{k,j} N^j$. Then

$$
\begin{align*}
&\sum_{i = 1}^n i^{k - 1} = c_{k-1,k} n^k + \sum_{j = 0}^{k - 1} c_{k-1,j} n^j \\
&\Rightarrow \sum_{n = 1}^N \sum_{i = 1}^n i^{k - 1} = \sum_{n = 1}^N c_{k-1,k} n^k + \sum_{j = 0}^{k - 1} c_{k-1,j} n^j \\
&\Rightarrow \sum_{n = 1}^N \sum_{i = 1}^n i^{k - 1} = c_{k-1,k} \sum_{n = 1}^N n^k + \sum_{n = 1}^N \sum_{j = 0}^{k - 1} c_{k-1,j} n^j \\
&\Rightarrow \sum_{n = 1}^N \sum_{i = 1}^n i^{k - 1} = c_{k-1,k} \cdot T_{k}(N) + \sum_{n = 1}^N \sum_{j = 0}^{k - 1} c_{k-1,j} n^j \\
\end{align*}
$$

The LHS can be simplified noting that each $i^{k-1}$ will appear in $N - i + 1$ sums, and then rewritten in terms of a polynomial in $N$

$$
\begin{align*}
\sum_{n = 1}^N \sum_{i = 1}^n i^{k - 1}
&= \sum_{i = 1}^N (N - i + 1) \cdot i^{k - 1} \\
&= (N + 1) \sum_{i = 1}^N i^{k - 1} - \sum_{i = 1}^N i^{k} \\
&= (N + 1) \sum_{i = 1}^N i^{k - 1} - T_{k}(N) \\
&= (N + 1) \sum_{j = 0}^{k} c_{k-1,j} N^j - T_{k}(N) \\
\end{align*}
$$

The RHS can be rewritten as a polynomial in $N$

$$
\begin{align*}
c_{k-1,k} \cdot T_{k}(N) + \sum_{n = 1}^N \sum_{j = 0}^{k - 1} c_{k-1,j} n^j
&= c_{k-1,k} \cdot T_{k}(N) + \sum_{j = 0}^{k - 1} c_{k-1,j} \sum_{n = 1}^N n^j \\
&= c_{k-1,k} \cdot T_{k}(N) + \sum_{j = 0}^{k - 1} c_{k-1,j} \sum_{i = 0}^{j + 1} c_{j,i} N^i \\
&= c_{k-1,k} \cdot T_{k}(N) + \sum_{i = 0}^{k} N^{i} \sum_{j = \text{max}(0, i-1)}^{k - 1} c_{k-1,j} \cdot c_{j,i} \\
\end{align*}
$$

Equating both sides we get

$$
(N + 1) \cdot \sum_{j = 0}^{k} c_{k-1,j} N^j - T_{k}(N) = c_{k-1,k} \cdot T_{k}(N) + \sum_{i = 0}^{k} N^{i} \sum_{j = \text{max}(0, i-1)}^{k - 1} c_{k-1,j} \cdot c_{j,i} \\
\Rightarrow (c_{k-1,k} + 1) \cdot T_{k}(N) = (N + 1) \cdot \sum_{j = 0}^{k} c_{k-1,j} N^j - \sum_{i = 0}^{k} N^{i} \sum_{j = \text{max}(0, i-1)}^{k - 1} c_{k-1,j} \cdot c_{j,i} \\
$$

Then by comparing coefficients we get:

$$
c_{k,k+1} = \frac{c_{k-1,k}}{c_{k-1,k} + 1} \\
\cdots \\
c_{k,i} = \frac{1}{c_{k-1,k} + 1} [c_{k-1,i-1} + c_{k-1,i} - \sum_{j = i-1}^{k - 1} c_{k-1,j} \cdot c_{j,i}] \\
\cdots \\
c_{k,0} = \frac{1}{c_{k-1,k} + 1} [c_{k-1,0} - \sum_{j = 0}^{k - 1} c_{k-1,j} \cdot c_{j,0} ] \\
$$

Finally, one can see by induction that $c_{k,0} = 0$.

### Calculating $S$

$$
\begin{align*}
S(N)
&= \sum_{k = 1}^M S_k(N) \\
&= \sum_{k = 1}^M \sum_{\substack{d = 1 \\ \text{$d$ is powerful}}}^N h_k(d) \cdot T_k(N / d) \\
&= \sum_{\substack{d = 1 \\ \text{$d$ is powerful}}}^N \sum_{k = 1}^M h_k(d) \cdot T_k(N / d) \\
\end{align*}
$$

Finally, the powerful numbers can be generated by using the fact that each powerful number $n = a^2 b^3$ has an unique representation where $b$ is squarefree. Then we just nead to iterate over all squarefree $b$, and for each $b$ generate all possible values of $a$ such that $n = a^2 b^3 \leq N$.